# Atelier — Specification (v2)

## 1. Purpose

Atelier is a **local, installable CLI tool** that manages **workspace-based development** for a single project. Each workspace represents one unit of work, one git branch, and (optionally) one agent coding session.

Atelier exists to eliminate branch switching, reduce cognitive load, and make agent-assisted development predictable, resumable, and human-interruptible.

Atelier is **tool-agnostic** by design. While it integrates well with Codex, it does not depend on any specific LLM or editor.

---

## 2. Core Concepts

### Project
A project is any directory initialized with Atelier. It is identified by a `.atelier.json` file at its root.

- A project has **one Atelier configuration**
- A project contains **many workspaces**
- Atelier commands operate relative to the nearest project root

### Workspace
A workspace is a directory representing one unit of work.

- One workspace → one git branch
- One workspace → one eventual pull request
- One workspace → one agent session (best-effort)
- Workspaces are created and managed by `atelier open`

### Repo
Each workspace contains a `repo/` directory that is a real git repository (clone of the project repo, checked out on a workspace-specific branch).

---

## 3. Filesystem Layout

### Project Root

```
project-dir/
├─ .atelier.json
├─ AGENTS.md
└─ workspaces/
```

### Workspace

```
workspaces/<workspace-name>/
├─ AGENTS.md
├─ .atelier.workspace.json
└─ repo/
```

---

## 4. Project Configuration: `.atelier.json`

`.atelier.json` is **application-owned state**. It is written and read by Atelier. Humans may inspect it, but it is not intended for frequent manual editing.

### v2 Schema (JSON)

```json
{
  "project": {
    "name": "gumshoe",
    "repo_url": "git@github.com:org/gumshoe.git"
  },
  "branch": {
    "default": "main",
    "prefix": "scott/"
  },
  "agent": {
    "default": "codex",
    "options": {
      "codex": ["--full-auto"],
      "claude": []
    }
  },
  "editor": {
    "default": "cursor",
    "options": {
      "cursor": ["-w"],
      "subl": ["-w"]
    }
  },
  "workspaces": {
    "root": "workspaces"
  },
  "atelier": {
    "id": "01J1Q5R6H4M2Z8Y6FZK2X9D8R3",
    "version": "0.2.0",
    "created_at": "2026-01-15T01:10:00Z"
  }
}
```

### Notes

- `atelier.id` is a **ULID**, generated once at initialization
- IDs are opaque and must not be parsed by consumers
- `agent.options` and `editor.options` are **static argv fragments only**
- No templating, interpolation, or logic is supported in config

---

## 5. Project-Level `AGENTS.md`

This file describes the **Atelier workflow overlay only**. It does not describe code layout or coding conventions.

### Default Template (v2)

```markdown
# Atelier Project Overlay

This project is managed using **Atelier**, a workspace-based workflow for
agent-assisted development.

## How Work Is Organized

- Development work is performed in isolated **workspaces**
- Workspaces live under the directory configured for this project
- Each workspace represents **one unit of work**
- Each workspace has its own `AGENTS.md` defining intent and scope

## Authority

- This file describes only the **Atelier workflow overlay**
- Workspace `AGENTS.md` files define execution expectations
- Repository-specific coding conventions are defined elsewhere
  (e.g. a repository-level `AGENTS.md`, if present)

- See `.atelier.json` for the current project configuration used by Atelier.
```

This file is generated by `atelier init`. Users may edit it, but most will not.

---

## 6. Workspace Configuration: `.atelier.workspace.json`

This file records workspace identity and provenance.

### v2 Schema

```json
{
  "workspace": {
    "name": "feat-org-api-keys",
    "branch": "scott/feat-org-api-keys",
    "id": "atelier:01J1Q5R6H4M2Z8Y6FZK2X9D8R3:feat-org-api-keys"
  },
  "atelier": {
    "version": "0.2.0",
    "created_at": "2026-01-15T02:03:00Z"
  }
}
```

---

## 7. Workspace `AGENTS.md`

This file is the **execution contract** for agents and humans.

### Structure

1. **Standard prologue** (owned by Atelier)
2. **User-owned intent**, with suggested headers and commented guidance

### Standard Prologue (v2)

```markdown
<!-- atelier:<atelier.id>:<workspace.name> -->

# Atelier Workspace

This directory is an **Atelier workspace**.

## Workspace Model

- This workspace represents **one unit of work**
- All code changes for this work should be made under `repo/`
- The code in `repo/` is a real git repository and should be treated normally
- This workspace maps to **one git branch** and **one eventual pull request**

## Execution Expectations

- Complete the work described in this file **to completion**
- Do not expand scope beyond what is written here
- Prefer small, reviewable changes over large refactors
- Avoid unrelated cleanup unless explicitly required

## Agent Context

When operating in this workspace:

- Treat this workspace as the **entire world**
- Do not reference or modify other workspaces
- Read the remainder of this file carefully before beginning work

After reading this file, proceed with the work described below.
```

### Suggested User Sections (commented)

```markdown
---

## Goal

<!-- Describe what this workspace is meant to accomplish. -->

## Context

<!-- Relevant background, links, tickets, or prior discussion. -->

## Constraints / Considerations

<!-- Technical, organizational, or temporal constraints. -->

## What “Done” Looks Like

<!-- Describe how to know when this workspace is complete. -->

## Notes

<!-- Optional execution notes or reminders. -->
```

Users may freely edit, reorder, or delete these sections.

---

## 8. CLI Commands (v2)

### `atelier init`

Initializes the current directory as an Atelier project.

#### Behavior

- Creates `.atelier.json` (or updates missing fields)
- Generates a ULID for `atelier.id` if missing
- Creates project-level `AGENTS.md` if missing
- Creates workspace root directory if missing
- Never modifies existing workspaces

---

### `atelier open <workspace-name>`

Ensures a workspace exists and launches or resumes agent work.

#### Behavior

1. Locate project root by walking up to `.atelier.json`
2. Ensure workspace directory exists
3. If workspace is new:
   - Generate `.atelier.workspace.json`
   - Generate workspace `AGENTS.md` from template
   - Open `AGENTS.md` in the configured editor (blocking)
4. Ensure `repo/` exists:
   - Clone repo if missing
   - Checkout default branch
   - Create workspace branch if missing
5. Launch agent:
   - Attempt to resume an existing Codex session by scanning local Codex transcripts
   - Otherwise start a new session with an opening prompt containing the workspace ID
   - Use `agent.options` and `codex -C <workspace-dir>` for execution

---

## 9. Codex Session Resumption (Best-Effort)

Atelier may attempt to resume Codex sessions by:

- Scanning `~/.codex/sessions/**` JSON/JSONL files
- Matching the first user message against:
  ```
  atelier:<atelier.id>:<workspace.name>
  ```
- Selecting the most recent match

If resumption fails, a new session is started.

Session resumption is **opportunistic** and must never be required for correctness.

---

## 10. Templates

Atelier ships with internal templates for:

- Project `AGENTS.md`
- Workspace `AGENTS.md`

If a project provides:

```
project-dir/templates/AGENTS.md
```

that file is used as the **workspace AGENTS.md template** instead of the built-in one.

Templates are **copied, not referenced**. Atelier never auto-updates existing files.

---

## 11. Non-Goals

Atelier does **not**:

- Manage multiple projects globally
- Create or manage GitHub repositories (v2)
- Enforce coding standards
- Track PRs or merges
- Maintain background processes
- Auto-upgrade templates

---

## 12. Implementation Guidelines (v2)

### Language & Runtime

- **Python 3.11+**
- Packaged as an installable CLI
- Installed via `pipx` or equivalent

### Tooling

- Use **`uv`** for:
  - dependency management
  - packaging
  - reproducible builds
- Use standard Python libraries where possible
- Prefer `subprocess` for invoking git, agent, and editor commands

### CLI Framework

- Use a mature CLI framework (e.g. `typer` or `argparse`)
- Commands must be:
  - deterministic
  - safe by default
  - explicit about side effects

### Design Principles

- Filesystem is the source of truth
- No global registries
- No background services
- No hidden state
- Human intent before agent execution

---

## 13. Success Criteria (v2)

Atelier v2 is successful if:

- A user can initialize a project once
- Create multiple workspaces without branch switching
- Resume agent work reliably
- Interrupt and resume work using an editor
- Upgrade Atelier without breaking existing projects
