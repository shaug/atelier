#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
WORKSPACES_DIR="${ATELIER_WORKSPACES_DIR:-$ROOT_DIR/workspaces}"
TEMPLATES_DIR="$ROOT_DIR/templates"

say() {
  printf '%s\n' "$*"
}

die() {
  printf 'error: %s\n' "$*" >&2
  exit 1
}

need_cmd() {
  command -v "$1" >/dev/null 2>&1 || die "missing required command: $1"
}

prompt() {
  local prompt_text="$1"
  local default_value="${2:-}"
  local value=""

  if [[ -n "$default_value" ]]; then
    read -r -p "$prompt_text [$default_value]: " value
    value="${value:-$default_value}"
  else
    read -r -p "$prompt_text: " value
  fi

  printf '%s' "$value"
}

prompt_required() {
  local prompt_text="$1"
  local value=""

  while [[ -z "$value" ]]; do
    read -r -p "$prompt_text: " value
  done

  printf '%s' "$value"
}

escape_sed() {
  printf '%s' "$1" | sed -e 's/[\/&]/\\&/g'
}

render_workspace_template() {
  local src="$1"
  local dest="$2"
  local project_name="$3"
  local workspace_name="$4"
  local branch_name="$5"
  local ticket_link="$6"
  local goal="$7"
  local out_of_scope="$8"
  local success_criteria="$9"

  local project_name_escaped
  local workspace_name_escaped
  local branch_name_escaped
  local ticket_link_escaped
  local goal_escaped
  local out_of_scope_escaped
  local success_criteria_escaped

  project_name_escaped="$(escape_sed "$project_name")"
  workspace_name_escaped="$(escape_sed "$workspace_name")"
  branch_name_escaped="$(escape_sed "$branch_name")"
  ticket_link_escaped="$(escape_sed "$ticket_link")"
  goal_escaped="$(escape_sed "$goal")"
  out_of_scope_escaped="$(escape_sed "$out_of_scope")"
  success_criteria_escaped="$(escape_sed "$success_criteria")"

  sed \
    -e "s/__PROJECT_NAME__/${project_name_escaped}/g" \
    -e "s/__WORKSPACE_NAME__/${workspace_name_escaped}/g" \
    -e "s/__BRANCH_NAME__/${branch_name_escaped}/g" \
    -e "s/__TICKET_LINK__/${ticket_link_escaped}/g" \
    -e "s/__GOAL__/${goal_escaped}/g" \
    -e "s/__OUT_OF_SCOPE__/${out_of_scope_escaped}/g" \
    -e "s/__SUCCESS_CRITERIA__/${success_criteria_escaped}/g" \
    "$src" > "$dest"
}

need_cmd git

project="${1:-}"
work_type="${2:-}"
slug="${3:-}"

if [[ -z "$project" ]]; then
  project="$(prompt_required "Project name")"
fi

if [[ -z "$work_type" ]]; then
  work_type="$(prompt_required "Work type (feat/fix/chore/etc.)")"
fi

if [[ -z "$slug" ]]; then
  slug="$(prompt_required "Slug")"
fi

project_dir="$WORKSPACES_DIR/$project"
project_env="$project_dir/project.env"

if [[ ! -f "$project_env" ]]; then
  die "missing project.env: $project_env"
fi

set -a
# shellcheck disable=SC1090
source "$project_env"
set +a

project_name="${PROJECT_NAME:-}"
repo_url="${REPO_URL:-}"
default_branch="${DEFAULT_BRANCH:-}"
branch_prefix="${BRANCH_PREFIX:-}"
naming_pattern="${NAMING_PATTERN:-}"

if [[ -z "$project_name" ]]; then
  project_name="$project"
fi

if [[ -z "$repo_url" ]]; then
  repo_url="$(prompt_required "Repo URL")"
fi

if [[ -z "$default_branch" ]]; then
  default_branch="$(prompt "Default branch" "main")"
fi

if [[ -z "$branch_prefix" ]]; then
  branch_prefix="$(prompt "Branch prefix" "feat")"
fi

if [[ -z "$naming_pattern" ]]; then
  naming_pattern="{type}-{slug}"
fi

workspace_name="$naming_pattern"
workspace_name="${workspace_name//\{type\}/$work_type}"
workspace_name="${workspace_name//\{slug\}/$slug}"

if [[ -z "$workspace_name" ]]; then
  die "failed to compute workspace name"
fi

branch_name="$workspace_name"
if [[ -n "$branch_prefix" ]]; then
  branch_name="$branch_prefix/$workspace_name"
fi

workspace_dir="$project_dir/$workspace_name"

if [[ -e "$workspace_dir" ]]; then
  die "workspace already exists: $workspace_dir"
fi

mkdir -p "$workspace_dir"

say "Cloning repo..."
git clone "$repo_url" "$workspace_dir/repo"

git -C "$workspace_dir/repo" checkout "$default_branch"
git -C "$workspace_dir/repo" checkout -b "$branch_name"

if [[ ! -f "$TEMPLATES_DIR/workspace/AGENTS.md" ]]; then
  die "missing template: $TEMPLATES_DIR/workspace/AGENTS.md"
fi

ticket_link="$(prompt "Ticket link (optional)" "")"
goal="$(prompt_required "Goal")"
out_of_scope="$(prompt_required "Out of scope")"
success_criteria="$(prompt_required "Success criteria")"

render_workspace_template "$TEMPLATES_DIR/workspace/AGENTS.md" "$workspace_dir/AGENTS.md" \
  "$project_name" "$workspace_name" "$branch_name" "$ticket_link" \
  "$goal" "$out_of_scope" "$success_criteria"

say "Review the workspace intent before starting."
if [[ -n "${EDITOR:-}" ]]; then
  "$EDITOR" "$workspace_dir/AGENTS.md"
else
  say "Set \$EDITOR to auto-open: $workspace_dir/AGENTS.md"
fi

say ""
say "Next steps:"
say "cd $workspace_dir"
say "<agent command>"
