#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
WORKSPACES_DIR="${ATELIER_WORKSPACES_DIR:-$ROOT_DIR/workspaces}"
TEMPLATES_DIR="$ROOT_DIR/templates"

say() {
  printf '%s\n' "$*"
}

die() {
  printf 'error: %s\n' "$*" >&2
  exit 1
}

need_cmd() {
  command -v "$1" >/dev/null 2>&1 || die "missing required command: $1"
}

prompt() {
  local prompt_text="$1"
  local default_value="${2:-}"
  local value=""

  if [[ -n "$default_value" ]]; then
    read -r -p "$prompt_text [$default_value]: " value
    value="${value:-$default_value}"
  else
    read -r -p "$prompt_text: " value
  fi

  printf '%s' "$value"
}

prompt_required() {
  local prompt_text="$1"
  local value=""

  while [[ -z "$value" ]]; do
    read -r -p "$prompt_text: " value
  done

  printf '%s' "$value"
}

escape_sed() {
  printf '%s' "$1" | sed -e 's/[\/&]/\\&/g'
}

normalize_github_repo() {
  local input="$1"
  local slug="$input"

  case "$input" in
    https://github.com/*|http://github.com/*)
      slug="${input#*github.com/}"
      ;;
    git@github.com:*)
      slug="${input#git@github.com:}"
      ;;
    github.com/*)
      slug="${input#github.com/}"
      ;;
  esac

  slug="${slug%.git}"
  slug="${slug%/}"

  if [[ "$slug" != */* ]]; then
    return 1
  fi

  printf '%s' "$slug"
}

render_template() {
  local src="$1"
  local dest="$2"
  local project_name="$3"
  local repo_url="$4"
  local default_branch="$5"
  local branch_prefix="$6"

  local project_name_escaped
  local repo_url_escaped
  local default_branch_escaped
  local branch_prefix_escaped

  project_name_escaped="$(escape_sed "$project_name")"
  repo_url_escaped="$(escape_sed "$repo_url")"
  default_branch_escaped="$(escape_sed "$default_branch")"
  branch_prefix_escaped="$(escape_sed "$branch_prefix")"

  sed \
    -e "s/__PROJECT_NAME__/${project_name_escaped}/g" \
    -e "s/__REPO_URL__/${repo_url_escaped}/g" \
    -e "s/__DEFAULT_BRANCH__/${default_branch_escaped}/g" \
    -e "s/__BRANCH_PREFIX__/${branch_prefix_escaped}/g" \
    "$src" > "$dest"
}

need_cmd git
need_cmd gh

github_input="${1:-}"
project_name="${2:-}"

if [[ -z "$github_input" ]]; then
  github_input="$(prompt_required "GitHub repo (owner/name or URL)")"
fi

repo_slug="$(normalize_github_repo "$github_input" || true)"
if [[ -z "$repo_slug" ]]; then
  die "expected GitHub repo like owner/name or URL"
fi

repo_info="$(gh repo view "$repo_slug" --json sshUrl,defaultBranchRef,name -q '.sshUrl + "\n" + .defaultBranchRef.name + "\n" + .name' 2>/dev/null)" || {
  die "unable to read repo via gh; run 'gh auth login' and ensure the repo exists"
}

IFS=$'\n' read -r repo_url default_branch repo_name <<<"$repo_info"

if [[ -z "$repo_url" ]]; then
  die "failed to resolve repo URL for $repo_slug"
fi

if [[ -z "$default_branch" ]]; then
  default_branch="main"
fi

if [[ -z "$project_name" ]]; then
  project_name="$(prompt "Project name" "$repo_name")"
fi

project_dir="$WORKSPACES_DIR/$project_name"
project_yaml="$project_dir/project.yaml"

if [[ -e "$project_dir" ]]; then
  die "project already exists: $project_dir"
fi

branch_prefix="$(prompt "Branch prefix" "feat")"

mkdir -p "$project_dir"

if [[ ! -f "$TEMPLATES_DIR/project.yaml" ]]; then
  die "missing template: $TEMPLATES_DIR/project.yaml"
fi

render_template "$TEMPLATES_DIR/project.yaml" "$project_yaml" \
  "$project_name" "$repo_url" "$default_branch" "$branch_prefix"

create_agents="$(prompt "Create project-level AGENTS.md? (y/N)" "N")"
case "$create_agents" in
  y|Y|yes|YES)
    if [[ ! -f "$TEMPLATES_DIR/project/AGENTS.md" ]]; then
      die "missing template: $TEMPLATES_DIR/project/AGENTS.md"
    fi

    repo_url_display="$repo_url"
    if [[ -z "$repo_url_display" ]]; then
      repo_url_display="TBD"
    fi

    render_template "$TEMPLATES_DIR/project/AGENTS.md" "$project_dir/AGENTS.md" \
      "$project_name" "$repo_url_display" "$default_branch" "$branch_prefix"
    ;;
  *)
    ;;
esac

say "Created project at $project_dir"
